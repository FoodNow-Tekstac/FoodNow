<div class="page-header">
  <h2 class="page-title">Order Management</h2>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
  <button (click)="selectStatus('PENDING')" [class.active]="selectedStatus() === 'PENDING'">
    Pending <span class="order-count">{{ orderCounts().PENDING }}</span>
  </button>
  <button (click)="selectStatus('PREPARING')" [class.active]="selectedStatus() === 'PREPARING'">
    Preparing <span class="order-count">{{ orderCounts().PREPARING }}</span>
  </button>
  <button (click)="selectStatus('OUT_FOR_DELIVERY')" [class.active]="selectedStatus() === 'OUT_FOR_DELIVERY'">
    Out for Delivery <span class="order-count">{{ orderCounts().OUT_FOR_DELIVERY }}</span>
  </button>
  <button (click)="selectStatus('DELIVERED')" [class.active]="selectedStatus() === 'DELIVERED'">
    Delivered <span class="order-count">{{ orderCounts().DELIVERED }}</span>
  </button>
</div>

<!-- Kitchen Prep Summary -->
@if (kitchenPrepSummary().length > 0) {
  <div class="prep-summary-card">
    <h4 class="prep-summary-title">Total Items to Prepare</h4>
    <div class="prep-summary-list">
      @for(item of kitchenPrepSummary(); track item[0]) {
        <div class="prep-item">{{ item[1] }} x {{ item[0] }}</div>
      }
    </div>
  </div>
}

<!-- Order List -->
<div class="orders-list">
  @for (order of filteredOrders(); track order.id) {
    <div class="order-card">
      <!-- Card Header with ID, Customer Name, Time, and Price -->
      <div class="card-header">
        <div class="header-details">
          <div class="order-id">#{{ order.id }}</div>
          <!-- UPDATED: Accessing nested customer name -->
          @if(order.customer) {
            <div class="customer-info">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="customer-icon">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
              <span>{{ order.customer.name }}</span>
            </div>
          }
        </div>
        <div class="order-meta">
          <span class="order-time">{{ order.orderTime | date:'shortTime' }}</span>
          <span class="order-price">₹{{ order.totalPrice.toFixed(2) }}</span>
        </div>
      </div>

      <!-- Timer for Pending and Confirmed Orders -->
      @if (order.status === 'PENDING' || order.status === 'CONFIRMED') {
        <div class="timer-bar">
          <p class="order-timer">Time Elapsed: {{ timeSinceOrder()[order.id] || '0m 0s' }}</p>
        </div>
      }

      <!-- Order Items -->
      <div class="card-body">
        <ul class="items-list">
          @for(item of order.items; track $index) {
            <li>
              <span class="item-quantity">{{ item.quantity }}x</span>
              <span class="item-name">{{ item.itemName }}</span>
            </li>
          }
        </ul>
      </div>

      <!-- Order Actions -->
      <!-- UPDATED: Shows buttons for both PENDING and CONFIRMED statuses -->
      @if (order.status === 'PENDING' || order.status === 'CONFIRMED') {
        <div class="card-actions">
          <button (click)="acceptOrder(order)" class="action-btn accept-btn">Accept</button>
          <button (click)="rejectOrder(order)" class="action-btn reject-btn">Reject</button>
        </div>
      }
      @if (order.status === 'PREPARING') {
        <div class="card-actions">
          <button (click)="readyForPickup(order)" class="action-btn pickup-btn">Ready for Pickup</button>
        </div>
      }

      <!-- Delivered Review -->
      @if (order.status === 'DELIVERED' && order.hasReview) {
        <div class="card-footer">
          <p class="rating">
            Rating: 
            <span class="stars">
              {{ '★'.repeat(order.reviewRating || 0) }}{{ '☆'.repeat(5 - (order.reviewRating || 0)) }}
            </span>
          </p>
          @if(order.reviewComment) {
            <p class="review-comment">"{{ order.reviewComment }}"</p>
          }
        </div>
      }
    </div>
  } @empty {
    <!-- A completely redesigned, more professional empty state -->
    <div class="empty-state">
      <div class="empty-state__icon-wrapper">
        <svg class="empty-state__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M19,19H5V5h14V19z"/>
          <path d="M14 17H7v-2h7V17z M17 13H7v-2h10V13z M17 9H7V7h10V9z"/>
        </svg>
      </div>
      <h3 class="empty-state__title">No Orders Yet</h3>
      <p class="empty-state__text">When a new order is received, it will appear right here.</p>
    </div>
  }
</div>
